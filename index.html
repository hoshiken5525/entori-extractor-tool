<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>えんと〜り情報抽出ツール</title>
    <!-- Tailwind CSSを読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* 簡単なアニメーション効果 */
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      /* ボタンのホバーエフェクト */
      .copy-btn:hover {
        transform: scale(1.05);
      }
      /* ドラッグ&ドロップエリアのスタイル */
      .drop-zone-active {
        border-color: #2563eb; /* blue-600 */
        background-color: #eff6ff; /* blue-50 */
      }
    </style>
  </head>
  <body class="bg-gray-100 font-sans">
    <div class="container mx-auto p-4 sm:p-8 max-w-3xl">
      <header class="text-center mb-8">
        <h1
          class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-teal-400 flex items-center justify-center gap-3"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="36"
            height="36"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="text-blue-500"
          >
            <path
              d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"
            ></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <line x1="10" y1="9" x2="8" y2="9"></line>
          </svg>
          えんと〜り情報抽出ツール
        </h1>
        <p class="text-gray-600 mt-3">
          Excelファイルをアップロード、またはドラッグ＆ドロップしてください。
        </p>
      </header>

      <main>
        <!-- ファイルアップロードセクション -->
        <div
          id="drop-zone"
          class="bg-white p-6 rounded-lg shadow-md border-2 border-dashed border-gray-300 transition-all duration-300"
        >
          <form id="upload-form" class="flex flex-col items-center gap-4">
            <div class="relative flex-grow w-full text-center">
              <input
                type="file"
                id="file-input"
                name="file"
                class="hidden"
                accept=".xlsx, .xls"
              />
              <label
                for="file-input"
                id="file-label"
                class="w-full cursor-pointer text-gray-700 font-medium py-8 px-4 rounded-lg transition duration-300"
              >
                <span id="drop-text" class="text-lg"
                  >ここにファイルをドラッグ＆ドロップ<br />または<span
                    class="text-blue-600 font-bold"
                    >クリックしてファイルを選択</span
                  ></span
                >
              </label>
            </div>
            <button
              type="submit"
              id="submit-btn"
              class="w-full sm:w-auto bg-blue-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-blue-700 transition duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed text-lg"
            >
              <span id="btn-text">抽出実行</span>
              <span id="btn-spinner" class="hidden">処理中...</span>
            </button>
          </form>
          <!-- エラーメッセージ表示エリア -->
          <div
            id="error-message"
            class="text-red-500 mt-4 text-center font-medium"
          ></div>
        </div>

        <!-- 結果表示セクション -->
        <div
          id="results-container"
          class="mt-8 bg-white p-6 rounded-lg shadow-md hidden"
        >
          <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-3">
            抽出結果
          </h2>
          <div id="results" class="space-y-4">
            <!-- JavaScriptによって結果がここに挿入されます -->
          </div>
        </div>
      </main>
    </div>

    <script>
      const dropZone = document.getElementById("drop-zone");
      const uploadForm = document.getElementById("upload-form");
      const fileInput = document.getElementById("file-input");
      const fileLabel = document.getElementById("file-label");
      const dropText = document.getElementById("drop-text");
      const submitBtn = document.getElementById("submit-btn");
      const btnText = document.getElementById("btn-text");
      const btnSpinner = document.getElementById("btn-spinner");
      const resultsContainer = document.getElementById("results-container");
      const resultsDiv = document.getElementById("results");
      const errorMessageDiv = document.getElementById("error-message");

      // --- ドラッグ＆ドロップのイベント処理 ---
      ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(eventName, preventDefaults, false);
      });

      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }

      ["dragenter", "dragover"].forEach((eventName) => {
        dropZone.addEventListener(
          eventName,
          () => dropZone.classList.add("drop-zone-active"),
          false
        );
      });

      ["dragleave", "drop"].forEach((eventName) => {
        dropZone.addEventListener(
          eventName,
          () => dropZone.classList.remove("drop-zone-active"),
          false
        );
      });

      dropZone.addEventListener(
        "drop",
        (e) => {
          fileInput.files = e.dataTransfer.files;
          updateFileName();
        },
        false
      );

      // --- ここまでドラッグ＆ドロップ処理 ---

      // ファイルが選択されたらラベル名を更新
      fileInput.addEventListener("change", updateFileName);

      function updateFileName() {
        if (fileInput.files.length > 0) {
          dropText.innerHTML = `<span class="font-bold text-green-600">ファイル選択完了：</span> ${fileInput.files[0].name}`;
        } else {
          dropText.innerHTML = `ここにファイルをドラッグ＆ドロップ<br>または<span class="text-blue-600 font-bold">クリックしてファイルを選択</span>`;
        }
      }

      // フォームが送信されたときの処理
      uploadForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        if (fileInput.files.length === 0) {
          showError("Excelファイルを選択してください。");
          return;
        }

        setLoading(true);
        clearResults();

        const formData = new FormData();
        formData.append("file", fileInput.files[0]);

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });
          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || "不明なエラーが発生しました。");
          }
          displayResults(data);
        } catch (error) {
          showError(error.message);
        } finally {
          setLoading(false);
        }
      });

      // 結果を表示する関数
      function displayResults(data) {
        resultsContainer.classList.remove("hidden");
        data.forEach((item) => {
          const resultItem = document.createElement("div");
          resultItem.className =
            "flex flex-col sm:flex-row items-stretch sm:items-center gap-2 fade-in";

          resultItem.innerHTML = `
                    <label class="w-full sm:w-40 text-gray-600 font-semibold flex-shrink-0">${item.label}</label>
                    <input type="text" readonly value="${item.value}" class="flex-grow bg-gray-100 border rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button class="copy-btn w-full sm:w-auto bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-200 flex-shrink-0">コピー</button>
                `;
          resultsDiv.appendChild(resultItem);
        });

        document.querySelectorAll(".copy-btn").forEach((button) => {
          button.addEventListener("click", (e) => {
            const input = e.target.previousElementSibling;
            input.select();

            navigator.clipboard
              .writeText(input.value)
              .then(() => {
                const originalText = e.target.textContent;
                e.target.textContent = "コピー完了!";
                e.target.classList.replace("bg-green-500", "bg-indigo-500");
                setTimeout(() => {
                  e.target.textContent = originalText;
                  e.target.classList.replace("bg-indigo-500", "bg-green-500");
                }, 1500);
              })
              .catch((err) => {
                console.error("コピーに失敗しました", err);
                // alertは使わない方が良い場合もあるため、コンソール出力に留める
              });
          });
        });
      }

      function setLoading(isLoading) {
        submitBtn.disabled = isLoading;
        btnText.classList.toggle("hidden", isLoading);
        btnSpinner.classList.toggle("hidden", !isLoading);
      }

      function clearResults() {
        resultsDiv.innerHTML = "";
        resultsContainer.classList.add("hidden");
        errorMessageDiv.textContent = "";
      }

      function showError(message) {
        errorMessageDiv.textContent = message;
      }
    </script>
  </body>
</html>
